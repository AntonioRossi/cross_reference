<script>

temp_settings = {};
reference_codes = [];


$(function() {
  google.script.run.withSuccessHandler(initialiseSidebar).getSettings();
})


function initialiseSidebar(settings) {
  var names = [];
  
  for (var i in settings) {
    var set_array = settings[i].split('_'),
        name = set_array[1];
    names.push(name);
    temp_settings[name] = set_array;
    reference_codes.push(temp_settings[name][0].substr(0, 3));
  }

  var sorted_names = names.sort();

  for (var i in sorted_names) {
    var final_name = sorted_names[i]
    $('#category-select').append($('<option>', {
      text: final_name
    }))
  }

  $('#category-select').data('val', sorted_names[0]);

  updateSidebar(sorted_names[0]);

  if (sorted_names[0] !== 'Equation' | 'Figure' | 'Table')
    $('#delete-category').css('display', 'block');
  else
    $('#delete-category').css('display', 'none');
}


function updateSidebar(category) {

  var settings = temp_settings[category],
      label_code = settings[0],
      label_text = settings[2],
      reference_text = settings[6],
      style = {
        'lab_bold': settings[3],
        'lab_italic': settings[4],
        'lab_underline': settings[5],
        'ref_bold': settings[7],
        'ref_italic': settings[8],
        'ref_underline': settings[9]
      }
  
  $('#lab_code').html('#' + label_code);
  $('#lab_text').val(label_text);
  $('#ref_code').val(label_code.substr(0, 3)).html('#' + label_code.substr(0, 3));
  $('#ref_text').val(reference_text);
    
  $('.lab').find('.preview__text').html(label_text + '1');
  $('.ref').find('.preview__text').html(reference_text + '1');
  
  var css_properties = {
    'bold': 'font-weight',
    'italic': 'font-style',
    'underline': 'text-decoration'
  }

  for (var i in style) {
    var code = i.substr(0, 3),
        css_value_name = i.substr(4, i.length),
        button_id = '#' + code + '_' + css_value_name;
     
    var css_value = (style[i] === 'true') ? css_value_name : 'initial';
    $('.' + code).find('.preview__text').css(css_properties[css_value_name], css_value);

    if (style[i] === 'true') {
      $(button_id).addClass('style-button--selected');
    }
    else {
      $(button_id).removeClass('style-button--selected');
    }
  }
}


function selectCategory(category) {
  updateTemp();

  if (category === 'Equation' || category === 'Figure' || category === 'Table') {
    $('#delete-category').css('display', 'none');
  }
  else {
    $('#delete-category').css('display', 'block');
  }
  
  updateSidebar(category)
}


function updateTemp() {

  var prev_name = $('#category-select').data('val');
  
  var ts = [
    $('#lab_code').html().substr(1, 6),
    prev_name,
    $('#lab_text').val()
  ]
  
  var ids = [
    '#lab_bold',
    '#lab_italic',
    '#lab_underline',
    'ref_text',
    '#ref_bold',
    '#ref_italic',
    '#ref_underline'
  ]
  
  for (var i = 0; i < ids.length; i++) {
    if (ids[i] === 'ref_text') {
      ts.push($('#ref_text').val());
      continue;
    }
    if ($(ids[i]).hasClass('style-button--selected'))
      ts.push('true');
    else
      ts.push('null');
  }
  
  temp_settings[prev_name] = ts

  $('#category-select').data('val', $('#category-select').val());
}


function saveProperties() {
  $('#save').prop('disabled', true);
  updateTemp();
  google.script.run.updateProps(temp_settings);
  setTimeout(function() {$('#save').prop('disabled', false)}, 1000);
}


function revertCustomScreen() {

  var to_hide = '#custom-category-name, #cs_lab_code, .actions__row:last-child',
      to_show = '#category-select, #lab_code, .actions__row:not(:last-child)';
  
  $(to_hide).css('display', 'none');
  $(to_show).css('display', 'block');
  $('#add-category').css('display', 'block');
  $('#set_defaults').prop('disabled', false);
}


function revertToFirstCategory() {
  var safe_categories = ['Equation', 'Figure', 'Table'],
      first_category = $('#category-select option:first').val(),
      is_displayed = (safe_categories.indexOf(first_category) < 0) ? 'block' : 'none';
  
  $('#delete-category').css('display', is_displayed);
  $('#category-select').val($('#category-select option:first'));

  updateSidebar(first_category);
}


// *** User interactions with sidebar ***

$('#category-select').on('focusin', function() {
  $(this).data('val', $(this).val());
})


$('#category-select').on('change', function() {
  selectCategory(this.value)
})

$('#add-category').on('click', function() { 
  
  var to_hide = '.category__button, #category-select, #lab_code, .actions__row:not(:last-child)',
      to_show = '#custom-category-name, #cs_lab_code, .actions__row:last-child',
      to_clear = '#custom-category-name, #lab_code, #lab_code_entry, #lab_text, #ref_code, #ref_text';
   
  $(to_hide).css('display', 'none');
  $(to_show).css('display', 'block');
  $(to_clear).val('');
  $('#ref_code').html('#');
  $('.preview__text').css({'font-weight': 'normal',
                           'font-style': 'normal',
                           'text-decoration': 'none'
                      })
                     .html('&lt;element&gt;')

  $('.style-button--selected').removeClass('style-button--selected')
})


$('#delete-category').on('click', function() {
  var ref = $('#ref_code').html().substr(1, 4),
      current_name = $('#category-select').val();

  $(this).css('display', 'none')
  google.script.run.withSuccessHandler(revertToFirstCategory).removePair(ref);
  $('#category-select option:contains("' + current_name + '")').remove();
  
  if (reference_codes.indexOf(ref) !== -1) {
    reference_codes.splice(reference_codes.indexOf(ref), 1);
  }
})


$('#custom-category-name').keyup(function() {
  $('#category-select').data('val', this.value);
})


$('#lab_text').keyup(function() {
  $('.lab').find('.preview__text').html($(this).val() + '1');
})

$('#ref_text').keyup(function() {
  $('.ref').find('.preview__text').html($(this).val() + '1');
})


$('#lab_code_entry').keyup(function() {
  var label_code = $(this).val();
  
  $(this).val(label_code.toLowerCase());

  if (reference_codes.indexOf(label_code.substr(0, 3)) >= 0) {
    $('#taken').html('âš  in use')
               .css('color', '#9c3030');
    $(this).attr('maxlength', '3');
    $('#save-custom').prop('disabled', true)
    
  } else if (label_code.length === 5) {
    $('#taken').html('');
    $('#save-custom').prop('disabled', false)
    
  } else {
    $(this).attr('maxlength', '5');
    $('#taken').html('5 letters min')
               .css('color', 'gray');
    $('#save-custom').prop('disabled', true)
  }

  $('#lab_code').html('#' + label_code);
  $('#ref_code').html('#' + label_code.substr(0, 3));
})


$('.style-button').on('click', function() {
  $(this).toggleClass('style-button--selected');
  
  var id = this.id,
      css_value_name = id.substr(4, this.length),
      category_class = '.' + id.substr(0, 3);
    
  var css_properties = {
    'bold': 'font-weight',
    'italic': 'font-style',
    'underline': 'text-decoration'
  }
  
  var css_value = ($(this).hasClass('style-button--selected')) ? css_value_name : 'initial';
  
  $(category_class).find('.preview__text').css(css_properties[css_value_name], css_value);
})


$('#save-defaults').on('click', function() {
  updateTemp();
  google.script.run.withSuccessHandler().storeDefault(temp_settings)
})


$('#restore-defaults').on('click', function() {
  $('#category-select').find('option').remove().end();
  google.script.run.withSuccessHandler(initialiseSidebar).restoreDefault();
})


$('#save-apply').on('click', function() {
  saveProperties();
})


$('#cancel').on('click', function() {
  google.script.host.close()
})


$('#save-custom').on('click', function() {
  saveProperties();

  var custom_name = $('#custom-category-name').val(),
      custom_settings = temp_settings[custom_name];

  google.script.run.storeCustom(custom_settings);

  $('#category-select option:last').after($('<option>', {text: custom_name}))
  $('#category-select').val(custom_name);
  revertCustomScreen();
  $('#delete-category').css('display', 'block');
})


$('#cancel-custom').on('click', function() {
  revertToFirstCategory();
  revertCustomScreen();
})

</script>
