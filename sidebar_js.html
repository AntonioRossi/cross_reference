<script>
// Inititialise global objects

styles = {};
temp_settings = {}; // user settings not yet applied or saved
reference_codes = [];

//***** Initialise sidebar *****

// On sidebar open, retrieve settings and update sidebar

$(function() {
  refreshSidebar();
});

function refreshSidebar() {
  google.script.run.withSuccessHandler(initialiseSidebar).getSettings()
}

function initialiseSidebar(settings) {
  var names = [];
  
  for (var i in settings) {
    var set_array = settings[i].split('_');
    var name = set_array[1];
    names.push(name);
    temp_settings[name] = set_array;
    reference_codes.push(temp_settings[name][0].substr(0, 3));
  }

  var sorted_names = names.sort();

  for (var i in sorted_names) {
    var final_name = sorted_names[i]
    $('#name').append($('<option>', {
      text: final_name
    }))
  }

  $('#name').data('val', sorted_names[0]);

  updateSidebar(sorted_names[0]);

  if (sorted_names[0] != 'Equation' | 'Figure' | 'Table')
    $('#remove').css('display', 'block');
  else
    $('#remove').css('display', 'none');
}

function updateSidebar(name) {

  var csets = temp_settings[name];
  var clab_code = csets[0];
  var clab_text = csets[2];
  var cref_text = csets[6];

  var style = {
    'lab_bold': csets[3],
    'lab_italic': csets[4],
    'lab_underline': csets[5],
    'ref_bold': csets[7],
    'ref_italic': csets[8],
    'ref_underline': csets[9]
  }
  
  $('#lab_code').html('#' + clab_code);
  $('#lab_text').val(clab_text);
  $('#ref_code').val(clab_code.substr(0, 3)).html('#' + clab_code.substr(0, 3));
  $('#ref_text').val(cref_text);

  if (clab_text.charAt(0) === clab_text.charAt(0).toUpperCase())
    var lab2 = clab_text;
  else
    var lab2 = clab_text.charAt(0).toUpperCase() + clab_text.substr(1, clab_text.length);

  if (cref_text.charAt(0) === cref_text.charAt(0).toUpperCase())
    var ref2 = cref_text;
  else
    var ref2 = cref_text.charAt(0).toUpperCase() + cref_text.substr(1, cref_text.length);
    
  $('#lab_result').html(clab_text + ' 1');
  $('#lab_result2').html(lab2 + ' 1');
  $('#ref_result').html(cref_text + ' 1');
  $('#ref_result2').html(ref2 + ' 1');


  for (var i in style) {
    var code = i.substr(0, 3),
    att = i.substr(4, i.length),
    button_id = '#' + code + '_' + att;

    var css_props = {
      'bold': 'font-weight',
      'italic': 'font-style',
      'underline': 'text-decoration'
    }

    if (style[i] === 'true') {
      $('#' + code + '_result').css(css_props[att], att);
      $('#' + code + '_result2').css(css_props[att], att);
      $(button_id).addClass('st-selected')
    } else {
      $('#' + code + '_result').css(css_props[att], 'initial');
      $('#' + code + '_result2').css(css_props[att], 'initial');
      $(button_id).removeClass('st-selected')
    }
  }
}



//***** Actions within standard sidebar screen *****



// Store current name of pairing

$('#name').on('focusin', function() {
  $(this).data('val', $(this).val());
});

// Use name of element menu to update sidebar

function selectName(name) {
  updateTemp();

  var safe_names = ['Equation', 'Figure', 'Table'];

  if (safe_names.indexOf(name) < 0)
    $('#remove').css('display', 'block');
  else
    $('#remove').css('display', 'none');
  
  updateSidebar(name)
}

// Transfer sidebar settings to temporary object to be applied, saved as default etc.

function updateTemp() {

  var prev_name = $('#name').data('val');
  
  var ts = [
      $('#lab_code').html().substr(1, 6),
      prev_name,
      $('#lab_text').val()
  ]
  
  var ids = [
      '#lab_bold',
      '#lab_italic',
      '#lab_underline',
      'ref_text',
      '#ref_bold',
      '#ref_italic',
      '#ref_underline'
  ]
  
  for (var i = 0; i < ids.length; i++) {
    if (ids[i] === 'ref_text') {
      ts.push($('#ref_text').val());
      continue;
    }
    if ($(ids[i]).hasClass('st-selected'))
      ts.push('true');
    else
      ts.push('null');
  }
  
  temp_settings[prev_name] = ts

  $('#name').data('val', $('#name').val());
}

// Defaults

function storeDefault() {
  updateTemp();
  google.script.run.withSuccessHandler().storeDefault(temp_settings)
}

function restoreDefault(defaults) {
  $('#name').find('option').remove().end();
  initialiseSidebar(defaults);
}

// Save and apply current sidebar settings

function saveProperties() {
  $('#save').prop('disabled', true);
  updateTemp();
  google.script.run.updateProps(temp_settings);
  setTimeout(function() {$('#save').prop('disabled', false)}, 1000);
}

// Delete pairing

$('#remove').on('click', function() {
  var ref = $('#ref_code').html().substr(1, 4),
      current_name = $('#name').val();
  $('#remove').css('display', 'none');

  google.script.run.withSuccessHandler(cancelCustom).removePair(ref);
  
  $('#name option:contains("' + current_name + '")').remove();
  if (reference_codes.indexOf(ref) != -1)
    reference_codes.splice(reference_codes.indexOf(ref), 1);
});

//***** The custom screen *****



$('#add').on('click', function() {
  
  var to_hide = '#add, #remove, #name, #lab_code, .button-row1, .button-row2',
      to_show = '#custom_name, #cs_lab_code, .button-row-custom',
      to_clear = '#custom_name, #lab_code, #lab_code_entry, #lab_text, #ref_code, #ref_text',
      results = '#lab_result, #lab_result2, #ref_result, #ref_result2';
   
  $(to_hide).css('display', 'none');
  $(to_show).css('display', 'block');
  $(to_clear).val('');
  $('#ref_code').html('#');
  $(results).css({'font-weight': 'normal',
                  'font-style': 'normal',
                  'text-decoration': 'none'
                  })
            .html('&lt;element&gt;')

  $('.st-selected').removeClass('st-selected')
})

// Save custom settings

function saveCustom() {

  saveProperties();

  var name = $('#custom_name').val(),
      custom_settings = temp_settings[name];

  google.script.run.storeCustom(custom_settings);

  $('#name option:last').after($('<option>', {text: name}))
  $('#name').val(name);
  revertCustomScreen();
  $('#remove').css('display', 'block');
}

// Cancel custom settings

function cancelCustom() {

  var firstname = $('#name option:first').val(),
      safe_names = ['Equation', 'Figure', 'Table'];

  if (safe_names.indexOf(firstname) < 0)
    $('#remove').css('display', 'block');
  else
    $('#remove').css('display', 'none');
  
  $('#name').val($('#name option:first'));

  updateSidebar(firstname);

  revertCustomScreen();
  
}

// Revert to non-custom screen

function revertCustomScreen() {

  var to_hide = '#custom_name, #cs_lab_code, .button-row-custom',
      to_show = '#name, #lab_code, .button-row1, .button-row2';
  
  $(to_hide).css('display', 'none');
  $(to_show).css('display', 'block');
  $('#add').css('display', 'block');
  $('#set_defaults').prop('disabled', false);
}

//***** Dynamically update preview box when user changes settings *****


// Update label text

$('#lab_text').keyup(function() {
  var lab = $('#lab_text').val(),
      lab2 = lab.charAt(0).toUpperCase() + lab.substr(1, lab.length);
  
  $('#lab_result').html(lab + '1');
  $('#lab_result2').html(lab2 + '1');
});


//Update reference text   

$('#ref_text').keyup(function() {
  var ref = document.getElementById('ref_text').value,
      ref2 = ref.charAt(0).toUpperCase() + ref.substr(1, ref.length);

  $('#ref_result').html(ref + '1');
  $('#ref_result2').html(ref2 + '1');
});


// Update style


$('.style-button').on('click', function() {
  $(this).toggleClass('st-selected');
  var id = this.id,
      result = $('#' + id.substr(0, 3) + '_result'),
      result2 = $('#' + id.substr(0, 3) + '_result2');
  
  var att = id.substr(4, this.length);

  function button(ident, element, css, atton, attoff) {
    if (element.hasClass('st-selected')) {
      result.css(css, atton);
      result2.css(css, atton);
      styles[ident] = null;
    } else {
      result.css(css, attoff);
      result2.css(css, attoff);
      styles[ident] = true;
    }
  }

  if (att === 'bold') button(id, $(this), 'font-weight', 'bold', 'normal');
  if (att === 'italic') button(id, $(this), 'font-style', 'italic', 'normal');
  if (att === 'underline') button(id, $(this), 'text-decoration', 'underline', 'none');
});

// Update ref code in custom screen

$('#lab_code_entry').keyup(function() {
  var lab = $(this).val();
  $(this).val(lab.toLowerCase());

  if (reference_codes.indexOf(lab.substr(0, 3)) >= 0) {
    $('#taken').html('âš  in use')
               .css('color', '#D70000');
    $(this).attr('maxlength', '3');
    $('#save_custom').prop('disabled', true)
    
  } else if (lab.length == 5) {
    $('#taken').html('');
    $('#save_custom').prop('disabled', false)
    
  } else {
    $(this).attr('maxlength', '5');
    $('#taken').html('5 letters')
               .css('color', 'white');
    $('#save_custom').prop('disabled', true)
  }

  $('#lab_code').html('#' + lab);
  $('#ref_code').html('#' + lab.substr(0, 3));
})

// Update name (hidden) on custom screen
$('#custom_name').keyup(function() {
  var name = this.value;
  $('#name').data('val', name);
});

</script>
