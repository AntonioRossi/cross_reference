<!DOCTYPE html>
<html>
  <head>
    <base target='_top'>
    <link rel='stylesheet' href='https://ssl.gstatic.com/docs/script/css/add-ons1.css'>

    <style>
    * { 
      -moz-box-sizing:border-box; 
      -webkit-box-sizing:border-box; 
       box-sizing:border-box; 
    }
    
    h2 {
      
      margin-top:0;
      margin-bottom: 8px;
      color: black;
    }
    
    .main-wrapper {
    position:relative;
    width:100%;
    margin:0 auto;
    }
    
    select {
      background: url(https://ssl.gstatic.com/ui/v1/disclosure/grey-disclosure-arrow-up-down.png), white;
    }
    select, #custom_name {
    
    width: 100%;
    
    -moz-appearance: none;
    -webkit-appearance: none;
    background-position: 95% 50%;
    background-repeat: no-repeat;
    border: 1px solid #918F92;
    -moz-border-radius: 2px;
    -webkit-border-radius: 2px;
    border-radius: 0px;
    color: #333;
    cursor: default;
    font-family: arial, sans-serif;
    font-size: 24px;
    font-weight: bold;
    height: 70px;
    margin: 0;
    min-width: 72px;
    outline: 0;
    padding: 7px 19px 7px 10px;
    text-align: left;
    text-indent: .01px;
    white-space: nowrap;
}
    #custom_name {
      display: none
    }
    .details {
      width: 100%;
    }
    
    .labels, .references {
    color: black;
    padding: 24px;
    }
    
    .labels {
    background: #abbab7;
    }
    
    .references {
      background: #e1cdc2;
    }
    
    .xrow {
      height: 50px;
    }
    
    .xname, .style {
      float:left;
      width: 26%;
      padding-top: 5px;
      font-weight: bold;
    }
    
    .style {
      padding-top: 12px;
    }
    
    .xcontent {
      float:left
    }
    
    .style-button {
     float:left;
     width: 50px;
     height: 30px;
     background:white;
     cursor: default;
     margin: 4px 8px 4px 0;
     padding: 4px;
     padding-top: 6px;
     text-align: center;
     box-shadow: 1px 1px 1px 1px rgba(0,0,0,0.1);
    }
    
    .st-selected {
      background: indianred;
      color: white;
    }
    
    #lab_code, #ref_code {
      width:45px;
      height:26px;
      padding-top: 5px;
    }
    
    #cs_lab_code {
      display: none;
    }
    
    #cs_lab_code input {
      width: 60px;
    }
    
    #lab_text, #ref_text {
      width: 120px;
      height:26px;
      padding-left: 5px;
    }
    
    #taken {
      font-weight: bold;
      color: #D70000;
    }
    
    .shadedtext1, .shadedtext2 {
      float: left;
      color: rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .shadedtext1 {
      white-space: nowrap;
      margin-right: 5px;
    }
    .shadedtext2 {
      margin-left: 1px;
    }
 
    .result-row {
      width: 100%;
      height: 70px;
      margin-top: 30px;
      background: white;
      border-radius: 5px;
      border: 1px solid gray;
      box-shadow: inset 1px 1px 1px 1px rgba(0,0,0,0.2);
    }
    
    .line1, .line2 {
      height: 20px;
      width: 500px;
      overflow: hidden;
    }
  
    .results-internal {
      margin: auto;
      height: 60px;
      overflow: hidden;
      width: 85%;
      padding-top: 15px;
    }
    
    .hash {
      float: left;
      width:20px;
      height:26px;
      padding:4px;
      padding-right: 0px;
     -moz-box-sizing:border-box;
     -webkit-box-sizing:border-box;
      box-sizing:border-box;
    }
    
    .hash-input {
      float:left;
    }
    
    .actions {
      width: 100%;
    }
    
    .selection {
    height: 70px;
    }
    
    
    .selection .xrow {
      width: 100%;
      height: 80px;
      margin-top: 20px;
      padding: 22px 20px 20px 20px;
      background: #d57676;
    }
    
    .button-row1, .button-row2, .button-row-custom {
      height: 55px;
      position: relative;
    }
    
    .button-row1 {
      background: #e49767;
    }
    
    .button-row-custom {
      display: none;
    }
    
    #save {
      position: absolute;
      left:25px;
      top:15px;
    }
    
    #cancel {
      position: absolute;
      right:25px;
      top:15px;
    }
    
    #save_defaults {
      position: absolute;
      left:25px;
      top:12px;
    }
    
    #restore_defaults {
      position: absolute;
      right:25px;
      top:12px;
    }
    
    #add, #remove {
      position: absolute;
      cursor: pointer;
    }
    
    #add {
    top: 26px;
    -ms-transform: rotate(45deg);
    -webkit-transform: rotate(45deg);
    transform: rotate(45deg);
    color: #333;
    right: 31px;
    font-size: 11px;
    }
    
    #remove {
      top: 27px;
      right: 48px;
      color: indianred;
      display: none;
    }

    </style>
  </head>
  <body>
  <div class='main-wrapper'>
    <article class='selection'>
      <div id='remove'>❌</div>
      <div id='add'>❌</div>
      <select id='name' onchange='selectName(this.value)'>
      </select>
      <input id='custom_name' placeholder='Custom name' maxlength='20'/>
    </article> 
    <article class='details'>
      <div class='labels'>
        <div class='xrow'>
        <h2>Labels</h2>
        </div>
        <div class='xrow'>
          <div class='xname'>
            Code
          </div>
          <div class='xcontent'>
            <div class='hash-input'>
              <div id='lab_code'>
              </div>
              <div id='cs_lab_code'>
              #&nbsp;<input type='text' value='' id='lab_code_entry' maxlength='5'/>
              <span id='taken'></span>
              </div>
            </div>
          </div>
        </div>
        <div class='xrow'>
          <div class='xname'>
            Text
          </div>
          <div class='xcontent'>
            <input type='text' id='lab_text'/>
          </div>
        </div>
        <div class='xrow'>
          <div class='style'>
            Style
          </div>
          <div class='xcontent'>
            <div id='lab_bold' class='style-button' title='false'>
              Bold
            </div>
            <div id='lab_italic' class='style-button' title='false'>
              Italic
            </div>
            <div id='lab_underline' class='style-button' title='false'>
              ULine
            </div>
          </div>
        </div>
        <div class='result-row'>
          <div class='results-internal'>
            <div class = 'line1'>
              <div class='shadedtext1'>
                Rendered
              </div>
              <div class='xcontent' id='lab_result'>
                figure 1
              </div>
              <div class='shadedtext2'>
                . Early human migration route out of Africa
              </div>
            </div>
            <div class= 'line2'>
              <div class='xcontent' id='lab_result2'>
                Figure 1
              </div>
              <div class='shadedtext2'>
                . Early human migration route out of Africa
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class='references'>
        <div class='xrow'>
        <h2>References</h2>
        </div>
        <div class='xrow'>
          <div class='xname'>
            Code
          </div>
          <div class='xcontent' id='ref_code'>
            <em>#</em>
          </div>
        </div>
        <div class='xrow'>
          <div class='xname'>
            Text
          </div>
          <div class='xcontent'>
            <input type='text' id='ref_text'/>
          </div>
        </div>
        <div class='xrow'>
          <div class='style'>
            Style
          </div>
          <div class='xcontent'>
            <div id='ref_bold' class='style-button' title='false'>
              Bold
            </div>
            <div id='ref_italic' class='style-button' title='false'>
              Italic
            </div>
            <div id='ref_underline' class='style-button' title='false'>
              ULine
            </div>
          </div>
        </div>
        <div class='result-row'>
          <div class='results-internal'>
            <div class = 'line1'>
              <div class='shadedtext1'>
                the line in
              </div>
              <div class='xcontent' id='ref_result'>
                figure 1
              </div>
              <div class='shadedtext2'>
                &nbsp;represents the path of human
              </div>
            </div>
            <div class= 'line2'>
              <div class='shadedtext1'>
                to Ethiopia.
              </div>
              <div class='xcontent' id='ref_result2'>
                Figure 1
              </div>
              <div class='shadedtext2'>
                &nbsp;is accurate to within 100 miles
              </div>
            </div>
          </div>
        </div>
      </div>
    </article>
    <article class='actions'>
      <div class='button-row1'>
        <button id='save_defaults' onclick='storeDefault()'>
          Save defaults
        </button>
        <button id='restore_defaults' onclick='google.script.run.withSuccessHandler(restoreDefault).restoreDefault()'>
          Restore defaults
        </button>
      </div>
      <div class='button-row2'>
        <button id='save' onclick='saveProperties()' class='blue'>
          Save and apply
        </button>
        <button id='cancel' onclick='google.script.host.close()'>
          Cancel
        </button>
      </div>
      <div class='button-row-custom'>
        <button id='save_custom' onclick='saveCustom()' class='blue'>
          Save and apply
        </button>
        <button id='cancel_custom' onclick='cancelCustom()'>
           Cancel
        </button>
      </div>
    </article>
  </div>
  
  
  
  
  
  
    <script src='//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js'>
    </script>
    <script>
    
    // Inititialise global objects

    var styles = {};
    var temp_settings = {};
    var ref_codes = [];
    
//***** Initialise sidebar *****

    // On sidebar open, retrieve settings and update sidebar
    
    $(function() {
            refreshSidebar();
        });
        
    function refreshSidebar() {
      google.script.run.withSuccessHandler(initialiseSidebar).getSettings()
    }

    function initialiseSidebar(settings) {
      var names = [];
      for (var i in settings) {
        var set_array = settings[i].split('_');
        var name = set_array[1];
        names.push(name);
        temp_settings[name] = set_array;
        ref_codes.push(temp_settings[name][0].substr(0,3));
      }
   
      var sorted_names = names.sort();
      
      for (var i in sorted_names) {
        var final_name = sorted_names[i] 
        $('#name').append($('<option>', {text: final_name}))
      }

      $('#name').data('val', sorted_names[0]);

      updateSidebar(sorted_names[0]);
      
      if (sorted_names[0] != 'Equation' | 'Figure' | 'Table') {
        $('#remove').css('display', 'block');
      } else {
        $('#remove').css('display', 'none');
      }
    }

    function updateSidebar(name) {

      var csets = temp_settings[name];
      var clab_code = csets[0];
      var clab_text = csets[2];
      var cref_text = csets[6];
      
      var style = {'lab_bold': csets[3],
                   'lab_italic': csets[4],
                   'lab_underline': csets[5],
                   'ref_bold': csets[7],
                   'ref_italic': csets[8],
                   'ref_underline': csets[9]
                   }
      
      $('#lab_code').html('#' + clab_code);
      $('#lab_text').val(clab_text);
      $('#ref_code').val(clab_code.substr(0,3));
      $('#ref_code').html('#' + clab_code.substr(0,3));
      $('#ref_text').val(cref_text);
      
      if (clab_text.charAt(0) === clab_text.charAt(0).toUpperCase()) {
        var lab2 = clab_text
      } else {
        var lab2 = clab_text.charAt(0).toUpperCase() + clab_text.substr(1,clab_text.length);
      }
      
      if (cref_text.charAt(0) === cref_text.charAt(0).toUpperCase()) {
        var ref2 = cref_text
      } else {
        var ref2 = cref_text.charAt(0).toUpperCase() + cref_text.substr(1,cref_text.length);
      }
      $('#lab_result').html(clab_text + ' 1');
      $('#lab_result2').html(lab2 + ' 1');
      $('#ref_result').html(cref_text + ' 1');
      $('#ref_result2').html(ref2 + ' 1');
      
      
      for (var i in style) {
        var code = i.substr(0,3);
        var att = i.substr(4,i.length);
        var button_id = '#' + code + '_' + att;
        
        var css_props = {'bold': 'font-weight',
                         'italic': 'font-style',
                         'underline': 'text-decoration'
                         }
        
        if (style[i] === 'true') {
          $('#' + code + '_result').css(css_props[att], att);
          $('#' + code + '_result2').css(css_props[att], att);
          $(button_id).addClass('st-selected')
        } else {
          $('#' + code + '_result').css(css_props[att], null);
          $('#' + code + '_result2').css(css_props[att], null);
          $(button_id).removeClass('st-selected')
        }
      }
      
    }
    
//***** Actions within sidebar *****
    
    // Change the name (e.g. 'figure') of the element menu when user selects element from list
    
    $('#name').on('focusin', function(){
      $(this).data('val', $(this).val());
    });
    
    // Use name of element menu to update sidebar
    
    $('#remove').on('click', function () {
      //erase entry
    });
    
    
    function selectName(name) {
      updateTemp();
      
      var safe_names = ['Equation', 'Figure', 'Table'];
      
      if (safe_names.indexOf(name) < 0) {
        $('#remove').css('display', 'block');
      } else {
        $('#remove').css('display', 'none');
      }
      
        updateSidebar(name);
    }
    
    // Transfer sidebar settings to temporary object to be applied, saved as default etc.

    function updateTemp() {
    
      var prev_name = $('#name').data('val');
      var name = $('#name').val(); 
      var lab_code = $('#lab_code').html().substr(1,6);
      var lab_text = $('#lab_text').val();
      var ref_text = $('#ref_text').val();
      
      if ($('#lab_result').css('font-weight') === 'bold') {
        var lab_bold = 'true'
      } else {
        var lab_bold = 'null'
      }
      if ($('#lab_result').css('font-style') === 'italic') {
        var lab_italic = 'true'
      } else {
        var lab_italic = 'null'
      }
      if ($('#lab_result').css('text-decoration') === 'underline') {
        var lab_underline = 'true'
      } else {
        var lab_underline = 'null'
      }
      if ($('#ref_result').css('font-weight') === 'bold') {
        var ref_bold = 'true'
      } else {
        var ref_bold = 'null'
      }
      if ($('#ref_result').css('font-style') === 'italic') {
        var ref_italic = 'true'
      } else {
        var ref_italic = 'null'
      }
      if ($('#ref_result').css('text-decoration') === 'underline') {
        var ref_underline = 'true'
      } else {
        var ref_underline = 'null'
      }
      
      temp_settings[prev_name] = [
        lab_code,
        prev_name,
        lab_text,
        lab_bold,
        lab_italic,
        lab_underline,
        ref_text,
        ref_bold,
        ref_italic,
        ref_underline
      ]
      
      $('#name').data('val', $('#name').val());
    }

    // Defaults
    
    function storeDefault() {
    updateTemp();
    google.script.run.withSuccessHandler().storeDefault(temp_settings)
    }
    
    function restoreDefault(defaults) {
     $('#name')
    .find('option')
    .remove()
    .end();
    
     initialiseSidebar(defaults);
    }

    // Save and apply current sidebar settings
    
    function saveProperties() {
      
      $('#save').prop('disabled', true);
      updateTemp();
      google.script.run.updateProps(temp_settings);
      setTimeout(function() {
        $('#save').prop('disabled', 'false')
       }, 1000);
    }
    
//***** The custom screen *****

    $('#add').on('click', customScreen);
    
    function customScreen() {

      $('#add').css('display', 'none');
      $('#remove').css('display', 'none');
      
      // Change fields and buttons
      
      $('#name').css('display', 'none');
      $('#custom_name').css('display', 'block');

      $('#lab_code').css('display', 'none');
      $('#cs_lab_code').css('display', 'block');
      
      $('.button-row1').css('display', 'none');
      $('.button-row2').css('display', 'none');
      $('.button-row-custom').css('display', 'block');

      // Clear values
      
      $('#lab_code').val('');
      $('#lab_code_entry').val('');
      $('#lab_text').val('');
      $('#ref_code').val('');
      $('#ref_code').html('#');
      $('#ref_text').val('');
 
      // Update preview text

      var results = [
                     $('#lab_result'),
                     $('#lab_result2'),
                     $('#ref_result'),
                     $('#ref_result2')
                     ];
                     
      for (var i in results) {
        var t = results[i];
        t.css('font-weight', 'normal');
        t.css('font-style', 'normal');
        t.css('text-decoration', 'none');
        t.html('&lt;element&gt;')
      }
      
      $('.st-selected').removeClass('st-selected')
      
    }

    // Save custom settings
    
    function saveCustom() {
        
      saveProperties();
      
      var name = $('#custom_name').val();
      var custom_settings = temp_settings[name];
      
      google.script.run.storeCustom(custom_settings);
      
      $('#name option:last').after($('<option>', {text: name}))
      $('#name').val(name)
      revertCustomScreen()
    }

    // Cancel custom settings
    
    function cancelCustom() {
    
      $('#lab_code').val('');
      
      $('#name').val($('#name option:first'));
      
      revertCustomScreen();
      updateSidebar($('#name').val());
      $('#remove').css('display', 'none');
    }
    
    // Revert to non-custom screen
    
    function revertCustomScreen() {
      $('#name').css('display', 'block');
      $('#custom_name').css('display', 'none');
      
      $('#lab_code').css('display', 'block');
      $('#cs_lab_code').css('display', 'none');
      
      $('.button-row1').css('display', 'block');
      $('.button-row2').css('display', 'block');
      $('.button-row-custom').css('display', 'none');
      
      $('#add').css('display', 'block');
      $('#remove').css('display', 'block')
    }
    
    // Delete pairing
    
    $('#remove').on('click', function(){
      var ref = $('#ref_code').html();
      $('#remove').css('display', 'none');
      var current_name = $('#name').val();
      google.script.run.withSuccessHandler(cancelCustom).removePair(ref.substr(1,4));
      $('#name option:contains("' + current_name + '")').remove();
    });
       
    
//***** Dynamically update preview box when user changes settings *****
    
    // Update ref code on custom screen only
    
      $('#lab_code_entry').keyup(function(){
      var lab = $(this).val();
      $(this).val(lab.toLowerCase());
      
      if (ref_codes.indexOf(lab.substr(0,3)) >= 0) {
        $('#taken').html('⚠ in use');
        $(this).attr('maxlength', '3');
        $('#save_custom').prop('disabled', true);
      } else {
        $('taken').html('');
        $(this).attr('maxlength', '5');
        $('#save_custom').prop('disabled', false);
      }
      
      $('#lab_code').html('#' + lab);
      $('#ref_code').html('#' + lab.substr(0,3));
    })
    
    // Update name (hidden) on custom screen
    $('#custom_name').keyup(function() {
      var name = $('#custom_name').val();
      $('#name').data('val', name);
    });
    
    // Only allow user to save when label code is 5 letters
    
    $('#lab_code_entry').focusout(function() {
      if ($('#lab_code').html().length < 6){
       $('#taken').html('⚠ 5 letter min');
       $('#save_custom').prop('disabled', true)
      }
    });

    
    // Update label text

    $('#lab_text').keyup(function() {
      var lab = $('#lab_text').val();
      
      if (lab.charAt(0) === lab.charAt(0).toUpperCase()) {
        var lab2 = lab
      } else {
        var lab2 = lab.charAt(0).toUpperCase() + lab.substr(1,lab.length);
      }
      $('#lab_result').html(lab + '1');
      $('#lab_result2').html(lab2 + '1');
    });
    
    
    //Update reference text   
    
    $('#ref_text').keyup(function() {
      var ref = document.getElementById('ref_text').value;
      
      if (ref.charAt(0) === ref.charAt(0).toUpperCase()) {
        var ref2 = ref
      } else {
        var ref2 = ref.charAt(0).toUpperCase() + ref.substr(1,ref.length);
      }
      
      $('#ref_result').html(ref + '1');
      $('#ref_result2').html(ref2 + '1');
    });
    
    
    // Update style

    
    $('.style-button').on('click', function() {
      $(this).toggleClass('st-selected');
      
      var result = $('#' + this.id.substr(0,3) +'_result');
      var result2 = $('#' + this.id.substr(0,3) +'_result2');
      
      var id = this.id
      var att = id.substr(4,this.length);
      
      function button(ident, element, css, atton, attoff) {
        if (element.hasClass('st-selected')) {
          result.css(css, atton);
          result2.css(css, atton);
          styles[ident] = null;
        } else {
          result.css(css, attoff);
          result2.css(css, attoff);
          styles[ident] = true;
        }
      }
      
      if (att === 'bold') {
        button(id, $(this),'font-weight', 'bold', 'normal')
      }
      if (att === 'italic') {
        button(id, $(this),'font-style', 'italic', 'normal')
      }
      if (att === 'underline') {
        button(id, $(this),'text-decoration', 'underline', 'none')
      }
    });
    </script>
  </body>
</html>
